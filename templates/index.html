<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 ProTask - Professional Todo App</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary: #3B82F6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: rgba(255,255,255,0.95);
            --text-color: #111827;
            --navbar-bg: #3B82F6;
            --btn-contrast: #ffffff;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
        }
        
        .dark-theme {
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #111827;
            --card-bg: rgba(17, 24, 39, 0.9);
            --text-color: #e5e7eb;
            --navbar-bg: #3730a3; ;
        }
        
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: var(--text-color);
        }
        
        .todo-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .todo-item.work { border-left-color: #3B82F6; }
        .todo-item.personal { border-left-color: #10B981; }
        .todo-item.shopping { border-left-color: #F59E0B; }
        .todo-item.health { border-left-color: #EF4444; }
        .todo-item.learning { border-left-color: #8B5CF6; }
        .todo-item.urgent { border-left-color: #DC2626; }
        .todo-item.other { border-left-color: #6B7280; }
        
        .completed {
            opacity: 0.7;
            text-decoration: line-through;
        }
        
        .category-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .priority-high { background-color: #DC2626; }
        .priority-medium { background-color: #F59E0B; }
        .priority-low { background-color: #10B981; }
        
        .stats-card {
            transition: transform 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        /* Scroll buttons */
        .scroll-btn {
            position: fixed;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            z-index: 1050;
            border: none;
            color: #fff;
            background: var(--primary);
            opacity: 0.9;
        }
        .scroll-btn:hover { opacity: 1; }
        #scrollUp { bottom: 80px; }
        #scrollDown { bottom: 20px; }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .glass-card {
                margin: 5px;
                border-radius: 15px;
            }
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg" style="background-color: var(--navbar-bg);">
        <div class="container">
            <a class="navbar-brand text-white" href="#">
                <i class="fas fa-rocket me-2"></i>
                <strong>ProTask</strong>
            </a>
            <div class="navbar-nav ms-auto align-items-center">
                <button id="themeToggle" class="btn btn-outline-light btn-sm me-3" onclick="toggleTheme()" title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                <div id="userSection" style="display: none;">
                    <span class="navbar-text me-3 text-white" id="usernameDisplay"></span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App -->
    <div class="container py-4">
        <!-- Auth Section -->
        <div id="authSection">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="glass-card p-4 fade-in">
                        <div class="text-center mb-4">
                            <h3 class="fw-bold">Welcome to ProTask</h3>
                            <p class="text-muted">Your professional task manager</p>
                        </div>
                        
                        <!-- Login Form -->
                        <div id="loginForm">
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" value="demo@example.com">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" value="demo123">
                            </div>
                            <button class="btn btn-primary w-100 mb-3" onclick="login()">
                                <i class="fas fa-sign-in-alt me-2"></i>Sign In
                            </button>
                            <div class="text-center">
                                <a href="#" class="text-decoration-none" onclick="showRegister()">
                                    Don't have an account? Sign up
                                </a>
                            </div>
                        </div>
                        
                        <!-- Register Form -->
                        <div id="registerForm" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Username</label>
                                <input type="text" id="registerUsername" class="form-control" placeholder="Choose a username">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" id="registerPassword" class="form-control" placeholder="Create a password">
                            </div>
                            <button class="btn btn-success w-100 mb-3" onclick="register()">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                            <div class="text-center">
                                <a href="#" class="text-decoration-none" onclick="showLogin()">
                                    Already have an account? Sign in
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Todo Dashboard -->
        <div id="todoDashboard" style="display: none;">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-3 mb-4">
                    <div class="glass-card p-4 mb-4">
                        <h5 class="fw-bold mb-3">Quick Actions</h5>
                        <button class="btn btn-primary w-100 mb-2" onclick="showTodoForm()">
                            <i class="fas fa-plus me-2"></i>Add Task
                        </button>
                        <div class="btn-group w-100" role="group">
                            <button class="btn btn-outline-primary" onclick="filterTodos('all')">All</button>
                            <button class="btn btn-outline-primary" onclick="filterTodos('active')">Active</button>
                            <button class="btn btn-outline-primary" onclick="filterTodos('completed')">Done</button>
                        </div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="glass-card p-4">
                        <h5 class="fw-bold mb-3">Statistics</h5>
                        <div id="statisticsContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="col-lg-9">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="fw-bold m-0">My Tasks</h4>
                            <div class="input-group" style="max-width: 300px;">
                                <input type="text" id="searchInput" class="form-control" placeholder="Search tasks...">
                                <button class="btn btn-outline-secondary" onclick="searchTodos()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Todo List -->
                        <div id="todoList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Ready to load your tasks</p>
                                <button class="btn btn-primary mt-2" onclick="loadInitialData()">
                                    <i class="fas fa-sync me-2"></i>Load My Tasks
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Todo Modal -->
    <div class="modal fade" id="todoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="todoForm">
                        <input type="hidden" id="todoId">
                        <div class="mb-3">
                            <label class="form-label">Title *</label>
                            <input type="text" id="todoTitle" class="form-control" required placeholder="Enter task title">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea id="todoDescription" class="form-control" rows="3" placeholder="Enter task description (optional)"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Category</label>
                                <select id="todoCategory" class="form-select">
                                    <option value="work">💼 Work</option>
                                    <option value="personal">🏠 Personal</option>
                                    <option value="shopping">🛒 Shopping</option>
                                    <option value="health">🏥 Health</option>
                                    <option value="learning">📚 Learning</option>
                                    <option value="urgent">🚨 Urgent</option>
                                    <option value="other">📌 Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Priority</label>
                                <select id="todoPriority" class="form-select">
                                    <option value="low">🟢 Low</option>
                                    <option value="medium" selected>🟡 Medium</option>
                                    <option value="high">🔴 High</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="datetime-local" id="todoDueDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTodo()">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll buttons -->
    <button id="scrollUp" class="scroll-btn" aria-label="Scroll to top" title="Top" onclick="window.scrollTo({top:0, behavior:'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollDown" class="scroll-btn" aria-label="Scroll to bottom" title="Bottom" onclick="window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'})">
        <i class="fas fa-arrow-down"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS - MOVED TO BOTTOM OF BODY -->
    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;
        let allTodos = [];
        let currentFilter = 'all';

        // Theme
        function applySavedTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            if (saved === 'dark') {
                document.body.classList.add('dark-theme');
                const btn = document.getElementById('themeToggle');
                if (btn) btn.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            const btn = document.getElementById('themeToggle');
            if (btn) btn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        // API Base URL
        const API_BASE = '/api';

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM fully loaded, initializing app...');
            applySavedTheme();
            initializeApp();
            // show/hide scrollUp depending on position
            const up = document.getElementById('scrollUp');
            if (up) {
                const toggleUp = () => {
                    up.style.display = window.scrollY > 200 ? 'flex' : 'none';
                };
                toggleUp();
                window.addEventListener('scroll', toggleUp);
            }
        });

        function initializeApp() {
            console.log('✅ Initializing app with all DOM elements available');
            checkAuthStatus();
        }

        // Authentication Functions
        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            
            console.log('🔐 Checking auth status...', { hasToken: !!token, hasUser: !!user });
            
            if (token && user) {
                try {
                    authToken = token;
                    currentUser = JSON.parse(user);
                    showTodoDashboard();
                } catch (error) {
                    console.error('❌ Error parsing user data:', error);
                    clearAuthData();
                    showAuthSection();
                }
            } else {
                showAuthSection();
            }
        }

        function clearAuthData() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
        }

        function showAuthSection() {
            console.log('👤 Showing auth section');
            const authSection = document.getElementById('authSection');
            const todoDashboard = document.getElementById('todoDashboard');
            const userSection = document.getElementById('userSection');
            
            if (authSection) authSection.style.display = 'block';
            if (todoDashboard) todoDashboard.style.display = 'none';
            if (userSection) userSection.style.display = 'none';
        }

        function showTodoDashboard() {
            console.log('📊 Showing todo dashboard for:', currentUser?.username);
            const authSection = document.getElementById('authSection');
            const todoDashboard = document.getElementById('todoDashboard');
            const usernameDisplay = document.getElementById('usernameDisplay');
            const userSection = document.getElementById('userSection');
            const todoList = document.getElementById('todoList');
            const statisticsContent = document.getElementById('statisticsContent');
            
            if (authSection) authSection.style.display = 'none';
            if (todoDashboard) todoDashboard.style.display = 'block';
            if (usernameDisplay) usernameDisplay.textContent = currentUser?.username || 'User';
            if (userSection) userSection.style.display = 'flex';
            
            // Show loading state instead of immediately fetching
            if (todoList) {
                todoList.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Ready to load your tasks</p>
                        <button class="btn btn-primary mt-2" onclick="loadInitialData()">
                            <i class="fas fa-sync me-2"></i>Load My Tasks
                        </button>
                    </div>
                `;
            }
            
            if (statisticsContent) {
                statisticsContent.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted small">Load tasks to see statistics</p>
                    </div>
                `;
            }
        }

        // New function to load data only when user clicks
        async function loadInitialData() {
            console.log('📥 Loading initial data...');
            await loadTodos();
            await loadStatistics();
        }

        async function login() {
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            
            if (!emailInput || !passwordInput) {
                showAlert('Form elements not found', 'danger');
                return;
            }
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAlert('Please enter both email and password', 'danger');
                return;
            }
            
            try {
                console.log('🔐 Attempting login...');
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('✅ Login successful');
                    authToken = data.access_token;
                    currentUser = data.user;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showTodoDashboard();
                    showAlert('Login successful! Welcome back!', 'success');
                } else {
                    console.error('❌ Login failed:', data.error);
                    showAlert(data.error || 'Login failed', 'danger');
                }
            } catch (error) {
                console.error('❌ Login error:', error);
                showAlert('Login error: ' + error.message, 'danger');
            }
        }

        async function register() {
            const usernameInput = document.getElementById('registerUsername');
            const emailInput = document.getElementById('registerEmail');
            const passwordInput = document.getElementById('registerPassword');
            
            if (!usernameInput || !emailInput || !passwordInput) {
                showAlert('Form elements not found', 'danger');
                return;
            }
            
            const username = usernameInput.value;
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!username || !email || !password) {
                showAlert('Please fill all fields', 'danger');
                return;
            }
            
            try {
                console.log('👤 Attempting registration...');
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('✅ Registration successful');
                    authToken = data.access_token;
                    currentUser = data.user;
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showTodoDashboard();
                    showAlert('Account created successfully! Welcome!', 'success');
                    showLogin();
                } else {
                    console.error('❌ Registration failed:', data.error);
                    showAlert(data.error || 'Registration failed', 'danger');
                }
            } catch (error) {
                console.error('❌ Registration error:', error);
                showAlert('Registration error: ' + error.message, 'danger');
            }
        }

        function logout() {
            console.log('👋 Logging out...');
            clearAuthData();
            showAuthSection();
            showAlert('You have been logged out successfully.', 'info');
        }

        function showLogin() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const registerUsername = document.getElementById('registerUsername');
            const registerEmail = document.getElementById('registerEmail');
            const registerPassword = document.getElementById('registerPassword');
            
            if (loginForm) loginForm.style.display = 'block';
            if (registerForm) registerForm.style.display = 'none';
            if (registerUsername) registerUsername.value = '';
            if (registerEmail) registerEmail.value = '';
            if (registerPassword) registerPassword.value = '';
        }

        function showRegister() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            
            if (loginForm) loginForm.style.display = 'none';
            if (registerForm) registerForm.style.display = 'block';
            if (loginEmail) loginEmail.value = '';
            if (loginPassword) loginPassword.value = '';
        }

        // Todo Functions
        async function loadTodos() {
            if (!authToken) {
                console.error('❌ No auth token available');
                showAlert('Please login first', 'warning');
                return;
            }
            
            const todoList = document.getElementById('todoList');
            if (!todoList) {
                console.error('❌ Todo list element not found');
                return;
            }
            
            // Show loading state
            todoList.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading tasks...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading your tasks...</p>
                </div>
            `;
            
            try {
                console.log('📥 Loading todos...');
                const response = await fetch(`${API_BASE}/todos`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401 || response.status === 422) {
                    console.error('❌ Token invalid, logging out');
                    logout();
                    showAlert('Your session has expired. Please login again.', 'warning');
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    console.log('✅ Todos loaded:', data.todos?.length || 0);
                    allTodos = data.todos || [];
                    renderTodos();
                } else {
                    console.error('❌ Error loading todos:', data.error);
                    showAlert('Error loading tasks: ' + (data.error || 'Unknown error'), 'danger');
                    renderEmptyState();
                }
            } catch (error) {
                console.error('❌ Error loading todos:', error);
                showAlert('Network error loading tasks', 'danger');
                renderEmptyState();
            }
        }

        function renderEmptyState() {
            const todoList = document.getElementById('todoList');
            if (!todoList) return;
            
            todoList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">Failed to load tasks</h5>
                    <p class="text-muted">Please try again</p>
                    <button class="btn btn-primary mt-2" onclick="loadTodos()">
                        <i class="fas fa-sync me-2"></i>Try Again
                    </button>
                </div>
            `;
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            if (!todoList) return;
            
            const filteredTodos = filterTodosByStatus(allTodos);
            
            if (filteredTodos.length === 0) {
                todoList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No tasks found</h5>
                        <p class="text-muted">Add your first task to get started!</p>
                        <button class="btn btn-primary" onclick="showTodoForm()">
                            <i class="fas fa-plus me-2"></i>Add Your First Task
                        </button>
                    </div>
                `;
                return;
            }
            
            todoList.innerHTML = filteredTodos.map(todo => `
                <div class="todo-item ${todo.category} card mb-3 ${todo.completed ? 'completed' : ''}" data-todo-id="${todo.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="priority-dot priority-${todo.priority}"></span>
                                    <h6 class="card-title mb-0 me-2 ${todo.completed ? 'text-decoration-line-through' : ''}">
                                        ${todo.title}
                                    </h6>
                                    <span class="badge ${getCategoryClass(todo.category)} category-badge">
                                        ${getCategoryIcon(todo.category)} ${todo.category}
                                    </span>
                                </div>
                                ${todo.description ? `<p class="card-text text-muted small">${todo.description}</p>` : ''}
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        Created: ${new Date(todo.created_at).toLocaleDateString()}
                                        ${todo.due_date ? ` | Due: ${new Date(todo.due_date).toLocaleDateString()}` : ''}
                                    </small>
                                    <div>
                                        <button class="btn btn-sm ${todo.completed ? 'btn-warning' : 'btn-success'}" onclick="toggleTodo(${todo.id})">
                                            <i class="fas ${todo.completed ? 'fa-undo' : 'fa-check'} me-1"></i>
                                            ${todo.completed ? 'Reopen' : 'Complete'}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editTodo(${todo.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${todo.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterTodosByStatus(todos) {
            switch (currentFilter) {
                case 'active':
                    return todos.filter(todo => !todo.completed);
                case 'completed':
                    return todos.filter(todo => todo.completed);
                default:
                    return todos;
            }
        }

        function filterTodos(filter) {
            currentFilter = filter;
            renderTodos();
        }

        function searchTodos() {
            const searchInput = document.getElementById('searchInput');
            const todoList = document.getElementById('todoList');
            
            if (!searchInput || !todoList) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const filteredTodos = allTodos.filter(todo => 
                todo.title.toLowerCase().includes(searchTerm) || 
                (todo.description && todo.description.toLowerCase().includes(searchTerm))
            );
            
            if (filteredTodos.length === 0) {
                todoList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No tasks found</h5>
                        <p class="text-muted">No tasks match your search criteria</p>
                    </div>
                `;
                return;
            }
            
            todoList.innerHTML = filteredTodos.map(todo => `
                <div class="todo-item ${todo.category} card mb-3 ${todo.completed ? 'completed' : ''}" data-todo-id="${todo.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="priority-dot priority-${todo.priority}"></span>
                                    <h6 class="card-title mb-0 me-2 ${todo.completed ? 'text-decoration-line-through' : ''}">
                                        ${todo.title}
                                    </h6>
                                    <span class="badge ${getCategoryClass(todo.category)} category-badge">
                                        ${getCategoryIcon(todo.category)} ${todo.category}
                                    </span>
                                </div>
                                ${todo.description ? `<p class="card-text text-muted small">${todo.description}</p>` : ''}
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        Created: ${new Date(todo.created_at).toLocaleDateString()}
                                        ${todo.due_date ? ` | Due: ${new Date(todo.due_date).toLocaleDateString()}` : ''}
                                    </small>
                                    <div>
                                        <button class="btn btn-sm ${todo.completed ? 'btn-warning' : 'btn-success'}" onclick="toggleTodo(${todo.id})">
                                            <i class="fas ${todo.completed ? 'fa-undo' : 'fa-check'} me-1"></i>
                                            ${todo.completed ? 'Reopen' : 'Complete'}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editTodo(${todo.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${todo.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Todo Modal Functions
        function showTodoForm(todo = null) {
            const modalElement = document.getElementById('todoModal');
            if (!modalElement) {
                showAlert('Modal not found', 'danger');
                return;
            }
            
            const modal = new bootstrap.Modal(modalElement);
            const form = document.getElementById('todoForm');
            const modalTitle = document.getElementById('modalTitle');
            const todoId = document.getElementById('todoId');
            const todoTitle = document.getElementById('todoTitle');
            const todoDescription = document.getElementById('todoDescription');
            const todoCategory = document.getElementById('todoCategory');
            const todoPriority = document.getElementById('todoPriority');
            const todoDueDate = document.getElementById('todoDueDate');
            
            if (!form || !modalTitle || !todoId || !todoTitle || !todoCategory || !todoPriority) {
                showAlert('Form elements not found', 'danger');
                return;
            }
            
            if (todo) {
                modalTitle.textContent = 'Edit Task';
                todoId.value = todo.id;
                todoTitle.value = todo.title;
                if (todoDescription) todoDescription.value = todo.description || '';
                todoCategory.value = todo.category;
                todoPriority.value = todo.priority;
                if (todoDueDate) todoDueDate.value = todo.due_date ? todo.due_date.slice(0, 16) : '';
            } else {
                modalTitle.textContent = 'Add New Task';
                form.reset();
                todoId.value = '';
                todoCategory.value = 'work';
                todoPriority.value = 'medium';
            }
            
            modal.show();
        }

        async function saveTodo() {
            const form = document.getElementById('todoForm');
            const todoId = document.getElementById('todoId');
            const todoTitle = document.getElementById('todoTitle');
            const todoDescription = document.getElementById('todoDescription');
            const todoCategory = document.getElementById('todoCategory');
            const todoPriority = document.getElementById('todoPriority');
            const todoDueDate = document.getElementById('todoDueDate');
            
            if (!form || !todoId || !todoTitle || !todoCategory || !todoPriority) {
                showAlert('Form elements not found', 'danger');
                return;
            }
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const todoData = {
                title: todoTitle.value,
                description: todoDescription ? todoDescription.value : '',
                category: todoCategory.value,
                priority: todoPriority.value,
                due_date: todoDueDate && todoDueDate.value ? todoDueDate.value : null
            };
            
            try {
                const url = todoId.value ? `${API_BASE}/todos/${todoId.value}` : `${API_BASE}/todos`;
                const method = todoId.value ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(todoData)
                });
                
                if (response.status === 401 || response.status === 422) {
                    logout();
                    showAlert('Your session has expired. Please login again.', 'warning');
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('todoModal'));
                    if (modal) modal.hide();
                    await loadTodos();
                    await loadStatistics();
                    showAlert(todoId.value ? 'Task updated successfully!' : 'Task created successfully!', 'success');
                } else {
                    showAlert(data.error || 'Error saving task', 'danger');
                }
            } catch (error) {
                showAlert('Error saving task: ' + error.message, 'danger');
            }
        }

        async function toggleTodo(todoId) {
            try {
                const todo = allTodos.find(t => t.id === todoId);
                const response = await fetch(`${API_BASE}/todos/${todoId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ completed: !todo.completed })
                });
                
                if (response.status === 401 || response.status === 422) {
                    logout();
                    showAlert('Your session has expired. Please login again.', 'warning');
                    return;
                }
                
                if (response.ok) {
                    await loadTodos();
                    await loadStatistics();
                    showAlert(`Task marked as ${!todo.completed ? 'complete' : 'incomplete'}!`, 'success');
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Error updating task', 'danger');
                }
            } catch (error) {
                showAlert('Error updating task: ' + error.message, 'danger');
            }
        }

        function editTodo(todoId) {
            const todo = allTodos.find(t => t.id === todoId);
            showTodoForm(todo);
        }

        async function deleteTodo(todoId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/todos/${todoId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401 || response.status === 422) {
                    logout();
                    showAlert('Your session has expired. Please login again.', 'warning');
                    return;
                }
                
                if (response.ok) {
                    await loadTodos();
                    await loadStatistics();
                    showAlert('Task deleted successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert(data.error || 'Error deleting task', 'danger');
                }
            } catch (error) {
                showAlert('Error deleting task: ' + error.message, 'danger');
            }
        }

        // Statistics Functions
        async function loadStatistics() {
            if (!authToken) {
                return;
            }
            
            const statisticsContent = document.getElementById('statisticsContent');
            if (!statisticsContent) return;
            
            try {
                const response = await fetch(`${API_BASE}/statistics`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401 || response.status === 422) {
                    return; // Silently fail for statistics
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    renderStatistics(data);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function renderStatistics(stats) {
            const statisticsContent = document.getElementById('statisticsContent');
            if (!statisticsContent) return;
            
            const completionRate = stats.completion_rate || 0;
            
            statisticsContent.innerHTML = `
                <div class="text-center mb-4">
                    <div class="display-6 fw-bold text-primary">${completionRate.toFixed(1)}%</div>
                    <div class="text-muted">Completion Rate</div>
                </div>
                
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: ${completionRate}%"></div>
                </div>
                
                <div class="row text-center mb-3">
                    <div class="col-4">
                        <div class="fw-bold">${stats.total || 0}</div>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-success">${stats.completed || 0}</div>
                        <small class="text-muted">Done</small>
                    </div>
                    <div class="col-4">
                        <div class="fw-bold text-warning">${stats.pending || 0}</div>
                        <small class="text-muted">Pending</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6 class="fw-bold mb-2">By Category</h6>
                    ${Object.entries(stats.category_stats || {}).map(([category, count]) => `
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="badge ${getCategoryClass(category)} category-badge">
                                ${getCategoryIcon(category)} ${category}
                            </span>
                            <small class="text-muted">${count}</small>
                        </div>
                    `).join('')}
                    ${Object.keys(stats.category_stats || {}).length === 0 ? '<small class="text-muted">No tasks yet</small>' : ''}
                </div>
            `;
        }

        // Helper Functions
        function getCategoryClass(category) {
            const classes = {
                'work': 'bg-primary text-white',
                'personal': 'bg-success text-white',
                'shopping': 'bg-warning text-dark',
                'health': 'bg-danger text-white',
                'learning': 'bg-info text-white',
                'urgent': 'bg-danger text-white',
                'other': 'bg-secondary text-white'
            };
            return classes[category] || classes['other'];
        }

        function getCategoryIcon(category) {
            const icons = {
                'work': '💼',
                'personal': '🏠',
                'shopping': '🛒',
                'health': '🏥',
                'learning': '📚',
                'urgent': '🚨',
                'other': '📌'
            };
            return icons[category] || icons['other'];
        }

        // Alert function
        function showAlert(message, type) {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.alert-dismissible');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to appropriate container
            let container;
            const authSection = document.getElementById('authSection');
            const todoDashboard = document.getElementById('todoDashboard');
            
            if (authSection && authSection.style.display !== 'none') {
                container = authSection;
            } else if (todoDashboard) {
                container = todoDashboard;
            } else {
                console.error('No container found for alert');
                return;
            }
            
            container.insertBefore(alert, container.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>